# Workflow derived from https://github.com/r-lib/actions/tree/v2/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
  push:
    branches: [main, master, v0.5.4-beta]
  pull_request:
    branches: [main, master]

name: test-coverage

jobs:
  test-coverage:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v3

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          needs: coverage

      - name: Setup
        run: |
          R CMD INSTALL .

      - name: Coverage
        env:
          MATNAME: ${{ matrix.name }}
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }} 
        run: |
          docker run --rm -i \
            -e MATNAME=$MATNAME \
            -e GITHUB_ACTION=$GITHUB_ACTION \
            -e GITHUB_REPOSITORY=$GITHUB_REPOSITORY \
            -e GITHUB_REF=$GITHUB_REF \
            -e GITHUB_HEAD_REF=$GITHUB_HEAD_REF \
            -e GITHUB_RUN_ID=$GITHUB_RUN_ID \
            -e GITHUB_SHA=$GITHUB_SHA \
            -e CODECOV_TOKEN=$CODECOV_TOKEN \
            -v ${PWD}:/mnt -w /mnt -e CI=true ${cntr} \
            ${{ matrix.cmd }} -e \
            '(v <- Sys.getenv("MATNAME"));if (v == "release") covr::codecov(quiet = FALSE)'
